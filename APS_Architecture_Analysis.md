# APS 插件功能现状与架构审计 (Current Status Audit)

## 1. 核心职能现状 (Must-Have Implemented)
当前插件实质为 **高级工单排序器 (Advanced Dispatching Rule Sorter)**，仅具备 L1 级单机排序能力，**尚未具备真正的“排程 (Scheduling)”能力**。

| 核心功能                     | 现状描述                                               | 对应代码逻辑                                     |
| :--------------------------- | :----------------------------------------------------- | :----------------------------------------------- |
| **规则排序 (Dispatching)**   | 基于单一维度（时间、优先级、比率）对工单进行线性排序。 | `SchedulingRule` 枚举 (EDD, SPT, WSPT, CR, FIFO) |
| **字段映射 (Field Mapping)** | 支持异构数据源，通过配置映射读取关键字段。             | `FieldMappingItem` 类与 `UpdateResultField` 方法 |
| **数据清洗 (Normalization)** | 统一解析日期 (OADate/String) 和数值，处理空值。        | `ParseDateTime`, `ParseDouble`                   |

## 2. 职能边界 (Current Scope)
当前实现严格限制在 **“数据预处理与排序”** 阶段，与工业级排程存在本质区别。

| 明确不包含 (Out of Scope) | 现状说明                                                                     |
| :------------------------ | :--------------------------------------------------------------------------- |
| **时间推演 (Timeline)**   | **完全缺失**。不计算 `StartDate` 和 `EndDate`，无法回答“什么时候做完”。      |
| **产能约束 (Capacity)**   | **完全缺失**。不接收资源 (Machine/Person) 数据，不计算负荷率，无法识别瓶颈。 |
| **多工序 (Routing)**      | **完全缺失**。仅视工单为原子任务，不支持工艺路线拆解，无法处理前后置约束。   |
| **日历系统 (Calendar)**   | **完全缺失**。默认假设 24x7 连续工作，脱离实际生产环境。                     |

## 3. 数据模型现状 (Current Schema)

### 输入数据 (Input JSON)
当前插件仅接收一个扁平的对象数组，通过 `FieldMappings` 配置映射。

```json
[
  { 
    "工单号": "MO001", 
    "交期": "2023-10-30", 
    "工时": 2.5, 
    "权重": 1 
  },
  { 
    "工单号": "MO002", 
    "交期": "2023-10-20", 
    "工时": 1.0, 
    "权重": 5 
  }
]
// 配置参数：
// Rule: "EDD" (最早交期优先)
```

### 输出数据 (Output JSON)
当前插件仅输出排序后的数组，并增加一个序号字段。

```json
[
  { 
    "工单号": "MO002", 
    "交期": "2023-10-20", 
    "SequenceNo": 1  // 仅增加此字段，无时间信息
  },
  { 
    "工单号": "MO001", 
    "交期": "2023-10-30", 
    "SequenceNo": 2 
  }
]
```

## 4. 架构差距分析 (Gap Analysis)
与上一版规划的“工业级 APS”相比，当前版本存在 **断层式** 的功能缺失。

| 缺失模块         | 严重程度 | 影响评估                                                 |
| :--------------- | :------- | :------------------------------------------------------- |
| **时间计算引擎** | 🚨 致命   | 无法输出甘特图数据，用户拿到排序结果后依然无法安排生产。 |
| **资源模型**     | 🚨 致命   | 无法进行产能平衡，无法回答“能不能做完”。                 |
| **异常决策**     | ⚠️ 高     | 仅有数据格式校验，无业务层面的决策支持（如顺延、拆单）。 |

## 5. 异常处理现状
当前仅包含基础的数据有效性校验，属于防御性编程，而非业务逻辑。
*   **规则依赖检查**：如选 EDD 规则时，校验数据中必须有 `DueDate`，否则返回错误信息。
*   **数值解析容错**：解析失败时通过 `defaultValue` 兜底，未抛出阻断性异常。

---
**结论**：当前插件处于 **L1 (单机排序)** 阶段。若要实现“高级排程”，需重构核心，引入 **时间轴推演** 与 **资源模型**，向 **L2 (有限产能排程)** 演进。
