# APS L1.5 (RCCP) 场景与演示设计

本文档详细描述基于 **L1.5 粗能力计划 (RCCP)** 特性的演示场景与交互设计。该演示旨在展示插件如何帮助工厂进行宏观产能平衡与交期预测。

## 1. 核心价值主张
*   **产能可视化**：一眼看穿未来一段时间的产能负荷，发现瓶颈。
*   **自动均衡**：当某天产能不足时，自动将低优先级订单顺延，而非简单报错。
*   **交期承诺 (CTP)**：基于当前负荷，准确回答“客户这个单什么时候能做完？”。

---

## 2. 演示场景设计

### 场景一：多资源组产能排程 (Capacity Scheduling)
**用户故事**：
计划员小王每天早上需要安排未来一周的生产计划。工厂有“CNC加工中心”和“组装车间”两个资源组。他希望根据订单的交期和优先级，自动安排生产日期，并确保不超过每天的产能上限。

**演示流程**：
1.  **基础设置**：
    *   定义资源组 `CNC`：日产能 24小时（3台设备*8小时），效率 0.9。
    *   定义资源组 `Assembly`：日产能 16小时（2条线*8小时），效率 1.0。
2.  **订单录入**：
    *   导入 10 个工单，分别指向不同的资源组，加工时长从 2小时到 20小时不等。
    *   部分工单交期紧迫（EDD规则）。
3.  **执行排程**：
    *   选择规则：`EDD (最早交期优先)`。
    *   点击“**执行 RCCP 排程**”。
4.  **结果验证**：
    *   查看排程结果列表：工单被分配到了具体的日期。
    *   **关键点**：观察某一天原本堆积了 30小时的任务，插件自动将多余的任务顺延到了第二天。

### 场景二：插单与逾期预警 (Rush Order & Alert)
**用户故事**：
销售突然接了一个紧急大单，要求 3 天后交货。计划员需要评估插单对现有计划的影响。

**演示流程**：
1.  **新增插单**：
    *   录入一个新工单 `WO_RUSH_001`，时长 10小时，优先级设为 `10 (最高)`，交期为 `T+3`。
2.  **重排程**：
    *   选择规则：`WSPT (加权最短加工时间)` 或 `Priority (优先级)`。
    *   再次点击“**执行 RCCP 排程**”。
3.  **结果对比**：
    *   新工单被排到了 `T+1` 或 `T+2` 的最早空闲时段（或挤占了其他低优先级订单）。
    *   查看列表中的 `IsOverdue` 列，确认是否有其他低优先级订单因为这次插单而变红（逾期）。

---

## 3. 活字格 Demo 页面实现指南

建议创建一个名为 **“APS 排程工作台”** 的页面。

### 3.1 页面布局 (Layout)

```text
+-------------------------------------------------------+
|  [标题] APS 粗能力排程工作台 (L1.5 Demo)              |
+-------------------------------------------------------+
|  [参数配置区]                                         |
|  排程开始日期: [ 2026-02-16 ]  排序规则: [ EDD v ]    |
|  [ 执行排程 (按钮) ]                                  |
+-------------------------------------------------------+
|  [左侧：待排工单池]       |  [右侧：排程结果可视化]   |
|                          |                           |
|  工单号 | 资源 | 时长   |  [图表：资源负载柱状图]   |
|  WO001  | CNC  | 4.0    |  (X轴:日期, Y轴:工时)     |
|  WO002  | Assm | 8.0    |                           |
|  ...                     |  -----------------------  |
|                          |  [列表：排程详情]         |
|                          |                           |
|                          |  日期 | 工单 | 状态 | 逾期|
|                          |  2/16 | WO001| 正常 | 否  |
|                          |  2/16 | WO005| 正常 | 否  |
|                          |  2/17 | WO002| 顺延 | 是  |
+-------------------------------------------------------+
```

### 3.2 关键逻辑配置

#### 步骤 1：准备数据 (服务端命令: `PrepareData`)
*   从 `WorkOrder_List` 表查询 `Status='待排产'` 的数据。
*   从 `ResourceGroup_Master` 表查询所有资源组数据。
*   返回这两个 JSON 对象。

#### 步骤 2：调用插件 (服务端命令: `ExecuteAPS`)
*   **命令**：`APSPluginServerCommand`
*   **参数配置**：
    *   `WorkOrders`: `=PrepareData.WorkOrders` (来自上一步查询)
    *   `ResourceData`: `=PrepareData.Resources`
    *   `StartDate`: `=页面.排程开始日期`
    *   `Rule`: `=页面.排序规则`
    *   `ResultTo`: `ScheduledResult`
*   **后续操作**：
    *   使用“循环”命令遍历 `ScheduledResult`。
    *   在循环中，将结果写入 `Schedule_Details` 表（先清空旧结果或生成新 PlanID）。

#### 3.3 图表绑定
*   使用活字格内置图表或 ECharts 插件。
*   数据源：`Schedule_Details` 表。
*   维度：
    *   系列 1 (Stack): 正常工时 (`Sum(ProcessingTime)`)
    *   系列 2 (Line): 资源能力上限 (需要关联 `ResourceGroup_Master` 获取 `DailyCapacity`)

---

## 4. 数据结构映射回顾

确保 Demo 中的字段与插件参数一一对应：

| Demo 字段 (WorkOrder_List) | 插件内部字段 (InternalField) | 备注 |
| :--- | :--- | :--- |
| WONumber | OrderID | 唯一标识 |
| ProcessingTime | ProcessingTime | 核心计算依据 |
| DueDate | DueDate | EDD/CR 排序依据 |
| Priority | Priority | WSPT 排序依据 |
| **ResourceGroupID** | **ResourceGroupID** | **L1.5 新增：决定放入哪个桶** |
| ArrivalTime | ArrivalTime | 最早可开始时间 |

---

## 5. 验收标准 (Acceptance Criteria)

1.  **资源约束生效**：排出的计划中，同一天同一资源组的总工时 <= `DailyCapacity * Efficiency`（除非单工单超限）。
2.  **自动顺延生效**：当 T 日已满，多余工单自动排入 T+1 日。
3.  **结果回写成功**：`ScheduledDate` 和 `CapacityStatus` 正确写入数据库。
